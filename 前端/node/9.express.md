## express

1）使用express

创建服务

```javascript
const app = express();
```

监听端口

```javascript
const port = 8000;
app.listen(port, () => {
  console.log('server is listening on 8000');
});
```

监听路由

```javascript
//监听get请求
app.get('/', (req, res) => {
  //res.json 自动设置响应头为application/json
  res.status(200).json({
    message: 'you are visit my site',
  });
});

//监听post请求
app.post('/', (req, res) => {
  res.status(200).json({
    message: 'post requrst',
  });
});
```

✨返回字符串 res.end 

✨返回状态码res.status

✨返回json res.json(express自动为我们添加了响应头，因此不必在手动设置writeHead)



2）创建api的准则：rest架构 ⏰）50

* 获取资源：使用url
* 操作数据：使用http methods

例如： /tours

✨获取 tours url下的资源时：GET /tours

✨创建 tours url下的资源时：POST /tours

✨更新 tours url下的资源时：PUT/PATCH /tours

✨删除 tours url下的资源时：DELETE /tours

⭐️ 所以，get获取数据，当想对数据增删改查时，不是新建url(/tourDel)等，而是使用http methods，不改变url，否则将难以维护

<img src="https://raw.githubusercontent.com/player-404/images/main/%E6%88%AA%E5%B1%8F2021-09-03%20%E4%B8%8B%E5%8D%888.05.39.png" alt="截屏2021-09-03 下午8.05.39" style="zoom:50%;float: left" />



## 项目实战

目标：目标创建一个旅游网站的API

1.获取tours下的全部资源（get)

```javascript
const express = require('express');
const fs = require('fs');
//创建应用
const app = express();

//获取数据
const data = JSON.parse(
  fs.readFileSync(`${__dirname}/dev-data/data/tours-simple.json`, 'utf-8')
);

//监听路由
app.get('/api/v1/tours', (req, res) => {
  //返回数据
  res.status(200).json({
    status: 'success',
    result: data.length,
    data: {
      tours: data,
    },
  });
});
```

✨可以给api创建不同的版本，方便更新迭代



2.添加tours下的数据(post)

* 什么是中间件

   中间件的本质就是一个函数，在收到请求和返回相应的过程中做一些我们想做的事情

* express内置中间件

  * express.json	

    解析表单中的 JSON 格式的数据，如果不配置解析表单数据中间件，则 req.body 默认等于 undefined

```javascript
//中间件 将数据传入body
app.use(express.json());


//在tours下增加数据 （post增改）
app.post('/api/v1/tours', (req, res) => {
  //获取传递过来的数据
  const reqData = req.body;
  console.log('data', reqData);
  const id = data.length;
  const newTours = Object.assign({ id: id }, reqData);
  //合并数据
  data.push(newTours);
  //写入数据
  fs.writeFile(s
    `${__dirname}/dev-data/data/tours-simple.json`,
    JSON.stringify(data),
    'utf-8',
    (err) => {
      if (err) {
        console.log(err);
      } else {
        res.status(200).send('done');
      }
    }
  );
});

```



3.获取toues不同id的数据(get)

* url中的 `:id` 表示传入参数，该参数会被传入req.params对象之中，类似vue的动态路由

  eg: `/:id/:x/:y`

* url参数之后添加 `?` ，表示可选的传入参数

  Eg: `/id/:x?`

```javascript
//获取tours 不同id下的数据
app.get('/api/v1/tours/:id', (req, res) => {
  //获取id参数
  const id = req.params.id * 1;
  //获取tours 相应id下的数据
  const tours = data.find((item) => item.id === id);
  //输入id错误
  if (!tours) {
    return res.status(404).json({ status: '404 Not found', message: '非法id' });
  }
  //返回相应id哦数据
  return res.status(200).json({ status: 200, data: { tours } });
});

```



4.更新(修改)tours api下的数据(patch)

⚠️假定数据更新成功

```javascript
//修改tours api下的资源
app.patch('/api/v1/tours/:id', (req, res) => {
  const id = req.params.id * 1;
  if (!id || id.length > data.length) {
    return res.status(404).json({ status: 'fail', message: '非法id' });
  }
  const datas = req.body;
  res.status(200).json({ status: '数据更新成功', data: { datas } });
});
```



5.删除tours api下的数据（delete)

⚠️假定数据删除成功

```javascript
//删除tours api下的数据
app.delete('/api/v1/tours/:id', (req, res) => {
  const id = req.params.id * 1;
  if (!id || id > data.length) {
    return res.status(404).json({ status: '删除数据失败', message: '非法id' });
  }
  res.status(204).json({ status: '删除数据成功', data: null });
});
```



6.重构代码

抽离回调函数，并使用app.route重构代码

```javascript
//获取全部数据
const getAllTours = (req, res) => {
  res
    .status(200)
    .json({ status: '数据获取成功', result: data.length, data: { data } });
};

//获取id下数据
const getTours = (req, res) => {
  //获取id参数
  const id = req.params.id * 1;
  //获取tours 相应id下的数据
  const tours = data.find((item) => item.id === id);
  //输入id错误
  if (!tours) {
    return res.status(404).json({ status: '404 Not found', message: '非法id' });
  }
  //返回相应id哦数据
  return res.status(200).json({ status: 200, data: { tours } });
};

//增加数据
const addTours = (req, res) => {
  //获取传递过来的数据
  const reqData = req.body;
  console.log('data', reqData);
  const id = data.length;
  const newTours = Object.assign({ id: id }, reqData);
  //合并数据
  data.push(newTours);
  //写入数据
  fs.writeFile(
    `${__dirname}/dev-data/data/tours-simple.json`,
    JSON.stringify(data),
    'utf-8',
    (err) => {
      if (err) {
        console.log(err);
      } else {
        res.status(200).send('done');
      }
    }
  );
};

//更新数据
const updateTours = (req, res) => {
  const id = req.params.id * 1;
  if (!id || id > data.length) {
    return res.status(404).json({ status: '更新失败', message: '非法id' });
  }
  const datas = req.body;
  res.status(200).json({ status: '数据更新成功', data: { datas } });
};

//删除数据
const delTours = (req, res) => {
  const id = req.params.id * 1;
  if (!id || id > data.length) {
    return res.status(404).json({ status: '删除数据失败', message: '非法id' });
  }
  res.status(204).json({ status: '删除数据成功', data: null });
};

app.route('/api/v1/tours').get(getAllTours).post(addTours);
app
  .route('/api/v1/tours/:id')
  .get(getTours)
  .patch(updateTours)
  .delete(delTours);
```

