## Mogodb

### 1.安装

#### 	**mac安装**

​		推荐使用brew安装，参照[官方文档](https://docs.mongodb.com/manual/tutorial/install-mongodb-on-os-x/)

​		1）将DNS改为8.8.8.8

​		2）brew tap mongodb/brew

​		3）brew install mongodb-community@5.0

##### 		mac启动服务

​			brew services start mongodb-community@5.0

##### 		mac结束服务

​			brew services stop mongodb-community@5.0

##### 		使用mongodb shell

​			mongosh

##### 		mac 数据库文件位置

​			通过homebrew安装的默认位置: `/usr/local/var/mongodb`

​			查看数据库文件位置命令:  `db.serverCmdLineOpts()`

#### 	**centeros安装**

​	[参照官方文档][https://docs.mongodb.com/manual/tutorial/install-mongodb-on-red-hat/]

##### 		1）配置mongoDB yum源(参照官网，随时可能更新)

   	a）yum源配置文件目录：`/etc/yum.repos.d`

##### 		b）创建mongodb repo文件 `mongodb-org-5.0.repo`，写入以下配置

```json
[mongodb-org-5.0]
name=MongoDB Repository
baseurl=https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/5.0/x86_64/
gpgcheck=1
enabled=1
gpgkey=https://www.mongodb.org/static/pgp/server-5.0.asc
```

##### 		2）下载安装

​			a) `sudo yum install -y mongodb-org`

​			b) `etc/yum.conf`添加以下配置

```json
exclude=mongodb-org,mongodb-org-database,mongodb-org-server,mongodb-org-shell,mongodb-org-mongos,mongodb-org-tools

```

##### 		3）配置文件位置

​			a) 数据库文件位置

​				`/var/lib/mongo`

​			b) log文件位置

​				`/var/log/mongodb`

##### 		4）启动

​			sudo systemctl start mongod

##### 		5）停止

​			sudo systemctl stop mongod

##### 		6）重启

​			sudo systemctl restart mongod



### 2.使用

#### 创建数据库

##### 	1）使用命令 `use  数据库名称`

```sh
use dbname
```

		##### 	2）创建表(集合)

​		使用`db.name`创建表(集合)名

#### 插入数据(文档)

		##### 	1）insertOne 

​		插入一条数据(文档)： `db.dbname.insertOne(document)`			

		##### 	2）insertMany

​		插入多条数据(文档)：`db.dbname.insertMany([<document1>, <document2>])`

		##### 	3）insert

​		插入一条或多条数据(文档)：`db.dbname.insert(document 或者 document数组)`

#### 查询数据表(集合)

	##### 	1）查询数据表(集合)中的所有数据(文档)

​		find传入空值: `db.dbname.find()` 

	##### 	2）查询数据表(集合)中指定属性数据(文档)

​		find传入查询对象: `db.name.find({status: "D"})`  => 查询status值为D的数据(文档)		

	##### 	3）使用查询运算符$in

​		查询数据表(集合)中等于指定属性值的所有数据(文档)

​		接收一个条件数组，查询满足任意条件的数据(文档): `db.dbname.find({name: {$in: []}})`

​		📝 查询数据表(集合)中 name 为 张三 或 李四 的数据(文档)	

```sh
natours-test> db.tours.find({name: {$in: ["张三", "李四"]}})
[
  {
    _id: ObjectId("6139c863edbd8c8c0018d3e9"),
    name: '张三',
    from: [ { country: 'china', age: '30' } ]
  },
  {
    _id: ObjectId("6139c8aaedbd8c8c0018d3ea"),
    name: '李四',
    from: [ { country: 'USA', age: '55' } ]
  }
]
```

#### 4）复合查询

###### 	a）且(, & $and), 复合查询(查询条件都要满足)

​		`,`或`$and（接受条件数组）`

​		📝查询数据表中(集合)中 status 为 A 且 qty 为 45的数据(文档)

```sh
natours-test> db.tours.find({status: "A", qty: 45})
[
  {
    _id: ObjectId("6139e58d7e874fad7043d94c"),
    item: 'postcard',
    qty: 45,
    size: { h: 10, w: 15.25, uom: 'cm' },
    status: 'A'
  }
]
```

​		使用$and运算符

```sh
natours-test> db.tours.find({$and: [{status: "A"}, {qty: 45 }]})
[
  {
    _id: ObjectId("6139e58d7e874fad7043d94c"),
    item: 'postcard',
    qty: 45,
    size: { h: 10, w: 15.25, uom: 'cm' },
    status: 'A'
  }
]
```



###### 	b）或($or)，复合查询((查询条件满足任一)

​		`$or`：接收一个条件数组	

​		📝查询数据表中(集合)中status 为 D 或 name 为 张三的数据(文档)

```sh
natours-test> db.tours.find({$or: [{status: "D"}, {name: "张三"}]})
[
  {
    _id: ObjectId("6139c863edbd8c8c0018d3e9"),
    name: '张三',
    from: [ { country: 'china', age: '30' } ]
  },
  {
    _id: ObjectId("6139e58d7e874fad7043d94a"),
    item: 'paper',
    qty: 100,
    size: { h: 8.5, w: 11, uom: 'in' },
    status: 'D'
  },
  {
    _id: ObjectId("6139e58d7e874fad7043d94b"),
    item: 'planner',
    qty: 75,
    size: { h: 22.85, w: 30, uom: 'cm' },
    status: 'D'
  }
]
```

##### 5）嵌套查询 `.`

​	find中使用 `.` 查询嵌套属性，查询的嵌套属性必须位于`""`之中

​	📝查询 size 对象中 uom 为 in 的数据(文档)

```sh
natours-test> db.tours.find({"size.uom": "in"})
[
  {
    _id: ObjectId("6139e58d7e874fad7043d949"),
    item: 'notebook',
    qty: 50,
    size: { h: 8.5, w: 11, uom: 'in' },
    status: 'A'
  },
  {
    _id: ObjectId("6139e58d7e874fad7043d94a"),
    item: 'paper',
    qty: 100,
    size: { h: 8.5, w: 11, uom: 'in' },
    status: 'D'
  },
  {
    _id: ObjectId("6139f4217e874fad7043d94e"),
    item: 'notebook',
    qty: 50,
    size: { h: 8.5, w: 11, uom: 'in' },
    status: 'A'
  },
  {
    _id: ObjectId("6139f4217e874fad7043d94f"),
    item: 'paper',
    qty: 100,
    size: { h: 8.5, w: 11, uom: 'in' },
    status: 'D'
  }
]
```

​	and 查询:

​	📝查询h < 15 且 uom 为 in 且 status 为 D 的数据(文档)

```sh
natours-test> db.tours.find({"size.h": {$lt: 15}, "size.uom": "in", status: "D" })
[
  {
    _id: ObjectId("6139e58d7e874fad7043d94a"),
    item: 'paper',
    qty: 100,
    size: { h: 8.5, w: 11, uom: 'in' },
    status: 'D'
  },
  {
    _id: ObjectId("6139f4217e874fad7043d94f"),
    item: 'paper',
    qty: 100,
    size: { h: 8.5, w: 11, uom: 'in' },
    status: 'D'
  }
]
```



#### 查询所有数据库

```sh
show dbs
```

#### 查询数据表

##### 	1）使用命令 `find()`查询数据

​				`db.tours.find()`

​				✨id: 为自动创建的唯一标识符

​				✨mongodb数据类似于JSON,官方叫做BSON

##### 	

##### 	2）使用`find`命令条件查询命令



​		a）$or 操作符（或，满足任一条件）

​			查询price > 300 或者 rating > 4.4的数据

```sh
db.tours.find({ $or: [ {price: {$gt: 300 } }, {rating: {$gt: 4.4 }}]} )
```

​		

​		b）多条件查询 (且，条件都需要满足)

​			查询price > 300 且 rating > 4.4 的数据

```sh
db.tours.find({price: {$gt: 300 },rating:{$gt: 4.4 } })
```



​		c）按照正则表达式查找

​		...略



​		d）查询子文档(子属性)

​		文档类型:

```json
[
  {
    _id: ObjectId("6139c25b753842428cac7709"),
    name: '张三 ',
    form: { country: 'china', age: 20 }
  },
  { _id: ObjectId("6139c27d753842428cac770a"), name: '李四', age: 30 },
  { _id: ObjectId("6139c295753842428cac770b"), name: '王五', age: 40 }
]
```

​		查询form中country属性为china的值

```sh
db.tours.find({"form.country": "china" })
```

​	e）查询数组的方法

​		i）$elemMatch

​		

#### 查询逻辑运算符

​	a）$lt: 小于

​	b）$lte: 小于等于

​	c）$gt: 大于

​	d）$gte: 大于等于

​	e）$ne: 不存在或存在但不等于

​	f）$in: 存在并在指定数组中

​	g）$nin: 不存在或不在指定数组中

​	h）$or: 匹配两个或多个条件中的一个

​	i）$and: 匹配全部条件	





6）插入多条数据 => insetMany( [ ] )

![截屏2021-09-08 下午3.25.22](https://raw.githubusercontent.com/player-404/images/main/%E6%88%AA%E5%B1%8F2021-09-08%20%E4%B8%8B%E5%8D%883.25.22.png)

❗插入多条数据时，放在数组中



7）搜索数据 => find()

mongodb使用`find`传入一个搜索条件对象，进行数据搜索

 a）搜索name为张三的数据

<img src="https://raw.githubusercontent.com/player-404/images/main/%E6%88%AA%E5%B1%8F2021-09-08%20%E4%B8%8B%E5%8D%883.37.23.png" alt="截屏2021-09-08 下午3.37.23" style="float: left" width="60%"/>



b）使用运算符进行搜索 => $



​	i）lte:  小于等于

​		搜索price小于500的数据

<img src="https://raw.githubusercontent.com/player-404/images/main/%E6%88%AA%E5%B1%8F2021-09-08%20%E4%B8%8B%E5%8D%883.40.53.png" alt="截屏2021-09-08 下午3.40.53" style="float: left" width="60%"/>

​	

​	ii）lt:  小于 & gte:  大于等于

​			搜索同时搜索多个条件的数据(搜索 price < 500 且 rating >= 4.5)

<img src="https://raw.githubusercontent.com/player-404/images/main/%E6%88%AA%E5%B1%8F2021-09-08%20%E4%B8%8B%E5%8D%883.51.53.png" alt="截屏2021-09-08 下午3.51.53" width="76%" style="float: left"/>



c）$or 运算符

接受一个数据，数组中的条件任一满足即可

搜索价格小于500 或者 评分大于等于4.8的数据

<img src="https://raw.githubusercontent.com/player-404/images/main/%E6%88%AA%E5%B1%8F2021-09-08%20%E4%B8%8B%E5%8D%883.57.56.png" alt="截屏2021-09-08 下午3.57.56" style="float: left" width="76%"/>



8）搜索到的数据指定显示字段

​	a）搜索的结果只显示name字段 `{name: 1}`		<img src="https://raw.githubusercontent.com/player-404/images/main/%E6%88%AA%E5%B1%8F2021-09-08%20%E4%B8%8B%E5%8D%884.05.49.png" alt="截屏2021-09-08 下午4.05.49" style="float: left" width="%"/>



b）搜索的结果不显示name字段 `{name: 0}`![截屏2021-09-08 下午4.07.09](https://raw.githubusercontent.com/player-404/images/main/%E6%88%AA%E5%B1%8F2021-09-08%20%E4%B8%8B%E5%8D%884.07.09.png)



9）更新数据 => $set

​	✨使用更新方法，传入两个对象，一个对象为搜索条件，第二个对象为更新数据

​	a）更新一条数据 => updateOne

​	❗️即使匹配到多条数据，也只会更新匹配到的第一条数据	![截屏2021-09-08 下午4.18.43](https://raw.githubusercontent.com/player-404/images/main/%E6%88%AA%E5%B1%8F2021-09-08%20%E4%B8%8B%E5%8D%884.18.43.png)



b）更新多条数据 => updateMany

​	📝 将评分大于等于4.8，价格大于500的数据，添加premium属性，值为true

![截屏2021-09-08 下午4.38.15](https://raw.githubusercontent.com/player-404/images/main/%E6%88%AA%E5%B1%8F2021-09-08%20%E4%B8%8B%E5%8D%884.38.15.png)

✨这个方法会更新所有匹配到的数据

✨$set 更新指定数据时，没有找到指定的更新属性，则会创建该属性



10）替换数据 replaceOne & replaceMany

✨ replaceOne & replaceMany 接收两个对象，第一个时匹配条件，第二个时替换的文档

❗️替换数据不再需要使用 $set 

❗️数据将会整个被替换为第二个参数对象，而不是更新某个属性

![截屏2021-09-08 下午4.58.20](https://raw.githubusercontent.com/player-404/images/main/%E6%88%AA%E5%B1%8F2021-09-08%20%E4%B8%8B%E5%8D%884.58.20.png)



11）删除数据

a）删除多条匹配的数据 => deleteMany

```sh
natours-test> db.tours.deleteMany({ rating: {$lt: 4.5 }})
{ acknowledged: true, deletedCount: 2 }
```

b）删除一条匹配的数据 => deleteOne

```sh
natours-test> db.tours.deleteOne({name: "王二麻子" })
{ acknowledged: true, deletedCount: 1 }
```

c）删除全部数据

```sh
natours-test> db.tours.deleteMany({})
{ acknowledged: true, deletedCount: 0 }
```

​	✨传入空对象匹配全部数据

