#### expressé”™è¯¯å¤„ç†

##### 1.debug

ä½¿ç”¨googleå‡ºå“çš„`ndb`è°ƒè¯•nodeç¨‹åº

* å®‰è£…

  å…¨å±€å®‰è£…ï¼š`npm i -g ndb`

  å±€éƒ¨å®‰è£…ï¼š`npm i --save-dev ndb`

* ä½¿ç”¨

  é…ç½®`package.json`

  ```json
  
    "scripts": {
      "start": "nodemon server.js",
      "prd": "NODE_ENV=production nodemon server.js",
      "dev": "NODE_ENV=development nodemon server.js",
      "debug": "ndb server.js" // é…ç½®
    },
  ```

  

##### 2.å¤„ç†é”™è¯¯URL

```javascript
app.use("/api/v1/user", usersRouter);
app.use("/api/v1/tours", tourRouter);

// å¤„ç†é”™è¯¯URL
app.use("*", (req, res) => {
  res
    .status(404)
    .json({ status: "fail", message: `${req.originalUrl} ä¸å­˜åœ¨` });
});
```

ä¹‹å‰è·¯ç”±éƒ½ä¸åŒ¹é…ï¼Œè¯´æ˜URLä¸å­˜åœ¨ï¼Œåˆ™è¿›å…¥è¯¥ä¸­é—´ä»¶ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯



##### 3.é”™è¯¯å¤„ç†ä¼˜åŒ–

* åˆ›å»ºé”™è¯¯å¤„ç†ç±»`untils/errorHanding.js`

```javascript
class ErrorHanding extends Error {
  constructor(message, statusCode) {
    super(message);
    this.statusCode = statusCode;
    this.status = `${statusCode}`.startsWith(4) ? "fail" : " error";
    // åˆ›å»ºé”™è¯¯ ä¿å­˜åœ¨ ErrorHanding.stack ä¸­ ï¼ŒæŠ¥å‡ºé”™è¯¯å…·ä½“å‡ºç°åœ¨å“ªä¸ªä½ç½®
    Error.captureStackTrace(this, this.constructor);
  }
}

module.exports = ErrorHanding;
```

**Error.captureStackTrace ä½œç”¨ï¼š**

éšè—å†…éƒ¨çš„å®ç°ç»†èŠ‚ï¼Œä¼˜åŒ–é”™è¯¯æ ˆ

Error.captureStackTrace æ˜¯ Node.js æä¾›çš„ä¸€ä¸ª APIï¼Œå¯ä»¥ä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼š

```javascript
Error.captureStackTrace(targetObject[, constructorOpt])
```

Error.captureStackTrace ä¼šåœ¨ targetObject ä¸­æ·»åŠ ä¸€ä¸ª stack å±æ€§ï¼Œå¯¹è¯¥å±æ€§è¿›è¡Œè®¿é—®æ—¶ï¼Œå°†ä»¥å­—ç¬¦ä¸²çš„å½¢å¼è¿”å› Error.captureStackTrace() è¯­å¥è¢«è°ƒç”¨æ—¶çš„ä»£ç ä½ç½®ä¿¡æ¯ï¼ˆå³ï¼šè°ƒç”¨æ ˆå†å²ï¼‰ã€‚

é™¤äº† targetObjectï¼ŒcaptureStackTrace è¿˜æ¥æ”¶ä¸€ä¸ªç±»å‹ä¸º function çš„å¯é€‰å‚æ•° constructorOptï¼Œå½“ä¼ é€’è¯¥å‚æ•°æ—¶ï¼Œè°ƒç”¨æ ˆä¸­æ‰€æœ‰ constructorOpt å‡½æ•°ä¹‹ä¸Šçš„ä¿¡æ¯(åŒ…æ‹¬ constructorOpt å‡½æ•°è‡ªèº«)ï¼Œéƒ½ä¼šåœ¨è®¿é—® targetObject.stack æ—¶è¢«å¿½ç•¥ã€‚å½“éœ€è¦å¯¹ç»ˆç«¯ç”¨æˆ·éšè—å†…éƒ¨çš„å®ç°ç»†èŠ‚æ—¶ï¼ŒconstructorOpt å‚æ•°ä¼šå¾ˆæœ‰ç”¨ã€‚ä¼ å…¥ç¬¬ 2 ä¸ªå‚æ•°é€šå¸¸ç”¨äºè‡ªå®šä¹‰é”™è¯¯ï¼Œä¾‹å¦‚ï¼š

```shell
function MyError() {  Error.captureStackTrace(this, MyError)  this.name = this.constructor.name  this.message = 'you got MyError'}const myError = new MyError()console.log(myError)console.log(myError.stack)// è¾“å‡ºMyError { name: 'MyError', message: 'you got MyError' }Error    at Object.<anonymous> (/Users/nswbmw/Desktop/test/app.js:7:17)    at ...
```

å¦‚æœå»æ‰ captureStackTrace çš„ç¬¬ 2 ä¸ªå‚æ•°ï¼š

```shell
function MyError() {  Error.captureStackTrace(this)  this.name = this.constructor.name  this.message = 'you got MyError'}const myError = new MyError()console.log(myError)console.log(myError.stack)// è¾“å‡ºMyError { name: 'MyError', message: 'you got MyError' }Error    at new MyError (/Users/nswbmw/Desktop/test/app.js:2:9)    at Object.<anonymous> (/Users/nswbmw/Desktop/test/app.js:7:17)    at ...
```

**å¯ä»¥çœ‹å‡º**ï¼šå‡ºç°äº† MyError ç›¸å…³çš„è°ƒç”¨æ ˆï¼Œä½†æˆ‘ä»¬å¹¶ä¸å…³å¿ƒ MyError åŠå…¶å†…éƒ¨æ˜¯å¦‚ä½•å®ç°çš„ã€‚



* åˆ›å»ºä¸­é—´ä»¶

  ```javascript
  const ErrorHanding = require("./utils/errorHanding");
  const errorCon = require("./controller/errorController");
  // å¤„ç†é”™è¯¯URL
  app.use("*", (req, res, next) => {
    // è·³è½¬è‡³å¤„ç†é”™è¯¯çš„ä¸­é—´ä»¶
    next(new ErrorHanding(`${req.originalUrl} is not found`, 404));
  });
  app.use(errorCon);
  ```

  `controller/errorController.js`

  ```javascript
  module.exports = (err, req, res, next) => {
    console.log("error controller");
    err.statusCode = err.statusCode || 500;
    err.status = err.status || "error";
    res.status(err.statusCode).json({ status: err.status, message: err.message });
  };
  ```



##### 4.ä¼˜åŒ–try catch

å› ä¸º async await å‡ºé”™æ—¶å¯ä»¥ä½¿ç”¨catchæ•è·é”™è¯¯, æ‰€ä»¥å¯ä»¥è®² try catch è½¬æ¢ä¸º async await

```javascript
const catchAsync = (fn) => {
  return async (req, res, next) => {
    fn(req, res, next).catch(next); //next æœ¬ä½ä¸ºä¸€ä¸ªå‡½æ•°:ï¼ˆerrï¼‰ => {}
  };
};

//åˆ›å»ºæ—…æ¸¸æ•°æ®
exports.createTour = catchAsync(async (req, res, next) => {
  const tourData = await Tour.create(req.body);
  res.status(200).json({ status: "create success", data: { data: tourData } });
});

//ä¹‹å‰ä»£ç 
 try {
    const data = await Tour.findByIdAndUpdate(req.params.id, req.body, {
      new: true,
      //å¼€å¯æ•°æ®éªŒè¯
      runValidators: true,
    });
    //new: trueè¿”å›æ›´æ–°åçš„æ•°æ®è¿”å›
    //runValidators: éªŒè¯æ›´æ–°å€¼çš„typeæ˜¯å¦ç¬¦åˆè¦æ±‚
    res.status(200).json({ status: "update success", data: { data: data } });
  } catch (err) {
    res.status(400).json({ status: "fail", message: err });
  }
```

å…¨éƒ¨ä»£ç 

```javascript
const Tour = require("../models/tourModels");
const ApiFeature = require("../utils/apiFeature");
//
const catchAsync = (fn) => {
  return async (req, res, next) => {
    fn(req, res, next).catch((err) => {
      next(err);
    });
  };
};

//ä¸­é—´ä»¶ï¼šæŸ¥è¯¢è¯„åˆ†æœ€é«˜ä¸”ä¾¿å®œçš„äº”ä¸ªæ—…è¡Œç›®çš„åœ°
exports.topCheap5 = (req, res, next) => {
  req.query.limit = 5; //é™åˆ¶æŸ¥è¯¢æ•°æ®ä¸º5æ¡
  req.query.sort = "-ratingsAverage,price"; //é€‰å–è¯„åˆ†æœ€é«˜çš„5æ¡ï¼Œä¸”æŒ‰ç…§priceå‡åºæ’åº
  req.query.filter = "name,price,ratingsAverage,summary"; //é™åˆ¶å­—æ®µ
  next();
};

//è·å–å…¨éƒ¨æ—…æ¸¸æ•°æ®
exports.getTours = catchAsync(async (req, res, next) => {
  const feature = new ApiFeature(Tour.find(), req.query)
    .filter()
    .sort()
    .limit()
    .paging();
  //è¿”å›æŸ¥è¯¢æ•°æ®
  const toursAllData = await feature.query;
  // console.log("all data", toursAllData);
  res.status(200).json({
    status: "get success",
    results: toursAllData.length,
    data: { data: toursAllData },
  });
});

//è·å–æŒ‡å®šæ•°æ®
exports.getTour = catchAsync(async (req, res) => {
  const tourData = await Tour.findById(req.params.id);
  //findById = findOne({_id: id})ç®€å†™
  res.status(200).json({ status: "get success", data: { data: tourData } });
});

//åˆ›å»ºæ—…æ¸¸æ•°æ®
exports.createTour = catchAsync(async (req, res, next) => {
  const tourData = await Tour.create(req.body);
  res.status(200).json({ status: "create success", data: { data: tourData } });
});

//æ›´æ–°æ•°æ®
exports.updateTour = catchAsync(async (req, res) => {
  const data = await Tour.findByIdAndUpdate(req.params.id, req.body, {
    new: true,
    //å¼€å¯æ•°æ®éªŒè¯
    runValidators: true,
  });
  //new: trueè¿”å›æ›´æ–°åçš„æ•°æ®è¿”å›
  //runValidators: éªŒè¯æ›´æ–°å€¼çš„typeæ˜¯å¦ç¬¦åˆè¦æ±‚
  res.status(200).json({ status: "update success", data: { data: data } });
});

//åˆ é™¤æ•°æ®
exports.delTour = catchAsync(async (req, res) => {
  const data = await Tour.findByIdAndDelete(req.params.id, {
    rawResult: true,
  });
  //rawResult: è¿”å›åˆ é™¤çš„æ•°æ®
  res.status(200).json({ status: "delete success", data: { data: data } });
});

exports.tourStats = catchAsync(async (req, res) => {
  const stats = await Tour.aggregate([
    //pipeline
    {
      $match: { ratingsAverage: { $gte: 4 } },
    },
    //stages
    {
      //åˆ†ç»„
      $group: {
        //ä»¥å“ªä¸ªå­—æ®µåˆ†ç»„ï¼Œnullä¸åˆ†ç»„
        _id: "$difficulty",
        //$sum æ±‚æ€»å’Œ
        sum: { $sum: 1 },
        //$avg æ±‚å¹³å‡æ•°
        ratingAvg: { $avg: "$ratingsAverage" },
        priceAvg: { $avg: "$price" },
        priceSum: { $sum: "$price" },
        minPrice: { $min: "$price" },
        maxPrice: { $max: "$price" },
        name: { $push: "$name" },
      },
    },
    {
      $sort: { ratingAvg: -1 },
    },
  ]);
  res.status(200).json({ status: "success", data: { stats } });
});

//æŒ‰æœˆä»½åˆ†ç±»æ•°æ®
exports.tourTime = catchAsync(async (req, res) => {
  const year = req.params.year * 1;
  const tours = await Tour.aggregate([
    {
      //å±•å¼€æ–‡æ¡£æ•°æ®ä¸­çš„æ•°ç»„
      $unwisdnd: "$startDates",
    },
    {
      //åŒ¹é…æ•°æ®
      $match: {
        startDates: {
          $gte: new Date(`${year}-01-01`),
          $lte: new Date(`${year}-12-31`),
        },
      },
    },
    {
      //åˆ†ç±»
      $group: {
        _id: {
          $month: "$startDates",
        },
        name: { $push: "$name" },
        resultNum: { $sum: 1 },
      },
    },
    {
      //æ·»åŠ å±æ€§å­—æ®µ
      $addFields: {
        month: "$_id",
      },
    },
    {
      //æ§åˆ¶è¿”å›æ•°æ®å­—æ®µæ˜¯å¦æ˜¾ç¤ºï¼š 0 ä¸æ˜¾ç¤º 1 æ˜¾ç¤º
      $project: {
        _id: 0,
      },
    },
    {
      //æ’åº
      $sort: {
        resultNum: -1,
      },
    },
  ]);
  res.status(200).json({ status: "success", data: { data: tours } });
});

```

é€»è¾‘ï¼š

catchAsync è¿”å› ä¸€ä¸ªåŒ¿åå‡½æ•°

catchAsync ä¼ å…¥ä¸€ä¸ª async await å‡½æ•° fn

åŒ¹é…åˆ°è·¯ç”±æ—¶ï¼Œè°ƒç”¨åŒ¿åå‡½æ•°ï¼ŒåŒ¿åå‡½æ•°è°ƒç”¨ fn

fn ç­‰å¾… await æŸ¥è¯¢ç»“æœ, å‡ºé”™ è¿”å›reject çŠ¶æ€çš„ promise, æˆåŠŸ ç»§ç»­æ‰§è¡Œä¹‹åä»£ç 

catch error ä¹‹åï¼Œnext(err)ï¼šnextä¼ å…¥error, è°ƒè‡³ express å¤„ç†é”™è¯¯çš„ä¸­é—´ä»¶ï¼Œæ‰§è¡Œè¯¥ä¸­é—´ä»¶



##### 5.æ·»åŠ 404é”™è¯¯å¤„ç†

```javascript
const Tour = require("../models/tourModels");
const ApiFeature = require("../utils/apiFeature");
const catchAsync = require("../utils/catchAsync");
const ErrorHanding = require("../utils/errorHanding");

//è·å–æŒ‡å®šæ•°æ®
exports.getTour = catchAsync(async (req, res, next) => {
  const tourData = await Tour.findById(req.params.id);

  //æ·»åŠ 404é”™è¯¯å¤„ç†
  if (!tourData) {
    return next(new ErrorHanding("tour ID is not found", 404));
  }
  //findById = findOne({_id: id})ç®€å†™
  res.status(200).json({ status: "get success", data: { data: tourData } });
});

//åˆ›å»ºæ—…æ¸¸æ•°æ®
exports.createTour = catchAsync(async (req, res, next) => {
  const tourData = await Tour.create(req.body);
  res.status(200).json({ status: "create success", data: { data: tourData } });
});

//æ›´æ–°æ•°æ®
exports.updateTour = catchAsync(async (req, res, next) => {
  const data = await Tour.findByIdAndUpdate(req.params.id, req.body, {
    new: true,
    //å¼€å¯æ•°æ®éªŒè¯
    runValidators: true,
  });
  //new: trueè¿”å›æ›´æ–°åçš„æ•°æ®è¿”å›
  //runValidators: éªŒè¯æ›´æ–°å€¼çš„typeæ˜¯å¦ç¬¦åˆè¦æ±‚

  //æ·»åŠ 404é”™è¯¯å¤„ç†
  if (!data) {
    return next(new ErrorHanding("tour id is not found", 404));
  }
  res.status(200).json({ status: "update success", data: { data: data } });
});

//åˆ é™¤æ•°æ®
exports.delTour = catchAsync(async (req, res, next) => {
  const data = await Tour.findByIdAndDelete(req.params.id, {
    rawResult: true,
  });
  //rawResult: è¿”å›åˆ é™¤çš„æ•°æ®

  //æ·»åŠ 404é”™è¯¯å¤„ç†
  if (!data) {
    return next(new ErrorHanding("tour id is not found", 404));
  }
  res.status(200).json({ status: "delete success", data: { data: data } });
});


```

âœ¨æ ¹æ®idæ‰¾ä¸åˆ°è¯¥æ•°æ®ï¼Œåˆ™è¯´æ˜è¯¥æ•°æ®ä¸å­˜åœ¨ï¼Œè¿”å›404é”™è¯¯



##### 6.æ ¹æ®ä¸åŒç”Ÿäº§ç¯å¢ƒè¿”å›ä¸åŒé”™è¯¯ä¿¡æ¯

ç”Ÿäº§ç¯å¢ƒé¢å‘ç”¨æˆ·ï¼Œæ‰€ä»¥è¿”å›çš„ä¿¡æ¯éœ€ç®€å•æ˜“ç†è§£

å¼€å‘ç¯å¢ƒé¢å‘å¼€å‘ï¼Œæ‰€ä»¥é”™è¯¯éœ€è¯¦ç»†

ç”±æ­¤æˆ‘ä»¬éœ€æ ¹æ®ä¸åŒçš„ç¯å¢ƒè¿”å›ä¸åŒçš„é”™è¯¯ä¿¡æ¯

```javascript
//errorHanding.js
class ErrorHanding extends Error {
  constructor(message, statusCode) {
    super(message);
    this.statusCode = statusCode || 500;
    this.status = `${this.statusCode}`.startsWith(4) ? "fail" : " error";
    this.isOperational = true;
    Error.captureStackTrace(this, this.constructor);
  }
}

module.exports = ErrorHanding;

//errController.js
function sendErrorPrd(err, res) {
  //isOperational ç”¨æ¥æ ‡è®°æ˜¯å¦ä¸ºæ„å¤–é”™è¯¯
  if (err.isOperational) {
    res
      .status(err.statusCode)
      .json({ status: err.status, message: err.message });
  } else {
    //å¤„ç†æœªçŸ¥é”™è¯¯
    res.status(500).json({
      status: "error",
      message: "å‘ç”Ÿäº†ä¸€äº›é”™è¯¯",
    });
  }
}

function sendErrorDev(err, res) {
  res.status(err.statusCode).json({
    status: err.status,
    error: err,
    stack: err.stack,
    message: err.message,
  });
}

module.exports = (err, req, res, next) => {
  err.statusCode = err.statusCode || 500;
  err.status = err.status || "error";
  if (process.env.NODE_ENV !== "production") {
    sendErrorPrd(err, res);
  } else if (process.env.NODE_ENV !== "development") {
    sendErrorDev(err, res);
  }
};
```



##### 7.å¤„ç†mongodbé”™è¯¯

å°†mongodbé”™è¯¯åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è¿”å›å…·ä½“é”™è¯¯ä¿¡æ¯ç»™ç”¨æˆ·

ä¹‹å‰ï¼š

```javascript
if (err.isOperational) {
    res
      .status(err.statusCode)
      .json({ status: err.status, message: err.message });
  } else {
    //å¤„ç†æœªçŸ¥é”™è¯¯
    res.status(500).json({
      status: "error",
      message: "å‘ç”Ÿäº†ä¸€äº›é”™è¯¯",
    });
  }
```

ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬ç›´æ¥å°†mongodbé”™è¯¯è¿”å›ï¼Œå¯¼è‡´åœ¨express error ä¸­é—´ä»¶ä¸­ï¼Œerr æ²¡æœ‰æ·»åŠ  isOperational å±æ€§ï¼Œå› æ­¤ç›´æ¥è¿”å›æœªçŸ¥é”™è¯¯ï¼Œ

ç°åœ¨ï¼š

```javascript
if (err.name === "CastError") {
      error = errHandleDB(error);
    }

//å¤„ç†mongodbé”™è¯¯
function errHandleDB(err) {
  const message = `éæ³•å­—æ®µ ${err.path}: ${err.value}`;
  // new ErrorHanding ç»™error æ·»åŠ äº† isOperational å±æ€§å€¼ï¼Œä¸ä¸ºæœªçŸ¥é”™è¯¯
  return new ErrorHanding(message, 400);
}
```

æˆ‘ä»¬é’ˆå¯¹ä¸åŒçš„mongodbçš„é”™è¯¯ä¿¡æ¯ï¼Œåˆ›å»º ErrorHanding å®ä¾‹ï¼Œmessage, æ·»åŠ  isOperational å±æ€§ï¼Œ è¿”å›å“åº”çš„é”™è¯¯



* å¤„ç†æ— æ•ˆ _id

```javascript
const ErrorHanding = require("../utils/errorHanding");

//å¤„ç†mongodbé”™è¯¯
function errHandleDB(err) {
  const message = `éæ³•å­—æ®µ ${err.path}: ${err.value}`;
  // new ErrorHanding ç»™error æ·»åŠ äº† isOperational å±æ€§å€¼ï¼Œä¸ä¸ºæœªçŸ¥é”™è¯¯
  return new ErrorHanding(message, 400);
}

function sendErrorPrd(err, res) {
  //isOperational ç”¨æ¥æ ‡è®°æ˜¯å¦ä¸ºæ„å¤–é”™è¯¯
  if (err.isOperational) {
    res
      .status(err.statusCode)
      .json({ status: err.status, message: err.message });
  } else {
    //å¤„ç†æœªçŸ¥é”™è¯¯
    res.status(500).json({
      status: "error",
      message: "å‘ç”Ÿäº†ä¸€äº›é”™è¯¯",
    });
  }
}

module.exports = (err, req, res, next) => {
  err.statusCode = err.statusCode || 500;
  err.status = err.status || "error";
  let error = { ...err };
  if (process.env.NODE_ENV === "production") {
    //å¤„ç†mongodbé”™è¯¯
    if (err.name === "CastError") {
      error = errHandleDB(error);
    }
    sendErrorPrd(error, res);
  } else if (process.env.NODE_ENV === "development") {
    sendErrorDev(err, res);
  }
};
```

* å¤„ç†mongodbé‡å¤å­—æ®µé”™è¯¯

```javascript
const ErrorHanding = require("../utils/errorHanding");

//å¤„ç†mongodb æ•°æ®é‡å¤é”™è¯¯
function validateRepeatHanding(err) {
  const message = `${Object.keys(err.keyPattern)} å­—æ®µå·²å­˜åœ¨`;
  return new ErrorHanding(message, 400);
}

module.exports = (err, req, res, next) => {
  err.statusCode = err.statusCode || 500;
  err.status = err.status || "error";
  let error = { ...err };
  if (process.env.NODE_ENV === "production") {
    //å¤„ç†mongodbé”™è¯¯
    if (error.name === "CastError") {
      error = errHandleDB(error);
    }
    //å¤„ç†mongodbå­—æ®µé‡å¤
    if (error.code === 11000) {
      error = validateRepeatHanding(error);
    }
    sendErrorPrd(error, res);
  } else if (process.env.NODE_ENV === "development") {
    sendErrorDev(err, res);
  }
};
```



* å¤„ç†mongoose å­—æ®µéªŒè¯é”™è¯¯

```javascript
//å¤„ç†mongodbæ•°æ®éªŒè¯é”™è¯¯
function ValidatorError(err) {
  const messages = Object.values(err.errors).map((el) => el.message);
  return new ErrorHanding(`å­—æ®µé”™è¯¯ï¼š${messages.join("; ")}`, 400);
}

module.exports = (err, req, res, next) => {
  err.statusCode = err.statusCode || 500;
  err.status = err.status || "error";
  if (process.env.NODE_ENV === "production") {
    let error = null;
    //å¤„ç†mongodbé”™è¯¯
    if (err.name === "CastError") {
      error = errHandleDB(err);
    }
    //å¤„ç†mongodbå­—æ®µé‡å¤
    if (err.code === 11000) {
      error = validateRepeatHanding(err);
    }
    //å¤„ç†mongodbå­—æ®µéªŒè¯é”™è¯¯
    if (err.name === "ValidationError") {
      error = ValidatorError(err);
    }
    sendErrorPrd(error, res);
  } else if (process.env.NODE_ENV === "development") {
    sendErrorDev(err, res);
  }
};
```



##### 8.å…¨å±€é”™è¯¯å¤„ç†

åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬ä¸€ç›´å¤„ç†çš„äº‹server ä¸­çš„ç›¸å…³é”™è¯¯ï¼Œé‚£ä¹ˆå‡è®¾ serverä¹‹å¤–çš„é”™è¯¯å¦‚ä½•å¤„ç†å‘¢ï¼Œå¦‚mongodbé“¾æ¥é”™è¯¯ï¼Ÿ

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ node process çš„ `unhandledRejection`å¤„ç†promiseçš„catché”™è¯¯ï¼š

**unhandledRejection**ï¼š æ¯å½“ Promise è¢«æ‹’ç»å¹¶ä¸”åœ¨äº‹ä»¶å¾ªç¯çš„ä¸€ä¸ªè½®è¯¢å†…æ²¡æœ‰é”™è¯¯å¥æŸ„é™„åŠ åˆ°æ‰¿è¯ºæ—¶ï¼Œåˆ™ä¼šè§¦å‘ 'unhandledRejection' äº‹ä»¶

```javascript
const app = require("./app");
const mongoose = require("mongoose");
const dotenv = require("dotenv");

dotenv.config({ path: "./config.env" });

//è¿æ¥mongodb
mongoose.connect(process.env.DATABASE_SERVER).then(() => {
  console.log("moogose is connected");
});

port = process.env.PORT || 3000;
const server = app.listen(port, "localhost", () => {
  console.log("server is running at port 8000");
});

//å½“nodeä¸­å‡ºç°é”™è¯¯æ—¶ï¼Œ ä¼šæ‰§è¡Œè¯¥å‡½æ•°çš„å›è°ƒå‡½æ•°
//æ¯å½“ Promise è¢«æ‹’ç»å¹¶ä¸”åœ¨äº‹ä»¶å¾ªç¯çš„ä¸€ä¸ªè½®è¯¢å†…æ²¡æœ‰é”™è¯¯å¥æŸ„é™„åŠ åˆ°æ‰¿è¯ºæ—¶ï¼Œåˆ™ä¼šè§¦å‘ 'unhandledRejection' äº‹ä»¶
process.on("unhandledRejection", (err) => {
  console.log(`error: ${err.name}: ${err.message}`);
  //ä¼˜é›…çš„å…³é—­nodeè¿›ç¨‹
  server.close(() => {
    //å…³é—­nodeè¿›ç¨‹
    process.exit(1);
  });
});

```

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨`uncaughtException`å¤„ç†ä¸€èˆ¬æ€§é”™è¯¯

```javascript
const app = require("./app");
const mongoose = require("mongoose");
const dotenv = require("dotenv");

// å…¶ä»–æ™®é€šé”™è¯¯ æ”¾åœ¨æœ€å‰ é¿å…å‘ç”Ÿé”™è¯¯æ—¶ï¼Œè¯¥äº‹ä»¶æ²¡æœ‰æ³¨å†Œï¼Œå¯¼è‡´æ— æ³•æ•è·é”™è¯¯
process.on("uncaughtException", (err) => {
  console.log("æ„å¤–é”™è¯¯ ğŸ’¥");
  console.log(`error: ${err.name}: ${err.message}`);
  server.close(() => {});
});

dotenv.config({ path: "./config.env" });

//è¿æ¥mongodb
mongoose.connect(process.env.DATABASE_SERVER).then(() => {
  console.log("moogose is connected");
});

port = process.env.PORT || 3000;
const server = app.listen(port, "localhost", () => {
  console.log("server is running at port 8000");
});

//å½“nodeä¸­å‡ºç°é”™è¯¯æ—¶ï¼Œ ä¼šæ‰§è¡Œè¯¥å‡½æ•°çš„å›è°ƒå‡½æ•°
//æ¯å½“ Promise è¢«æ‹’ç»å¹¶ä¸”åœ¨äº‹ä»¶å¾ªç¯çš„ä¸€ä¸ªè½®è¯¢å†…æ²¡æœ‰é”™è¯¯å¥æŸ„é™„åŠ åˆ°æ‰¿è¯ºæ—¶ï¼Œåˆ™ä¼šè§¦å‘ 'unhandledRejection' äº‹ä»¶
process.on("unhandledRejection", (err) => {
  console.log(`error: ${err.name}: ${err.message}`);
  //ä¼˜é›…çš„å…³é—­nodeè¿›ç¨‹
  server.close(() => {
    //å…³é—­nodeè¿›ç¨‹
    process.exit(1);
  });
});

```

